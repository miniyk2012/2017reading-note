# 分布式消息队列

* ## 事件驱动架构

![](/assets/1.png)

消息队列通过**发布-订阅**模式工作，消息发送者和消息接收者之间**没有直接耦合**，消息发布者将消息发送到分布式消息队列就结束，不过消息接收者如何处理，消息接受者从消息队列取消息并进行处理，不管消息来源如何发消息。**新增业务**时，若对该类消息有兴趣，订阅该消息即可，不会影响原有业务。

消息接受者在接收到消息后，对其进行处理包装后，可以构成一个新的消息，再发布出去，待其他消息接收者进行处理，这样就可以形成一个流程。

* ## 分布式消息队列

分布式消息队列可以部署在单独的服务器上，应用程序通过远程访问接口存取消息，如下图所示：

![](/assets/2.png)

消息生产者通过远程接口将消息推送个消息队列服务器，消息队列服务器将消息加入到内存队列后返回成功的响应。

消息服务器通过查询消息订阅列表，把找到订阅该消息的消费者应用程序，然后根据FIFO的原则，通过远程通信接口将消息发送给消费者。

**伸缩性**：消息队列服务器是无状态的，因此要扩容时，直接增加集群中服务器数量即可，此外要更改生产者的消息队列服务器列表。

**可用性**：为了避免消息队列服务器内存不足，可以将多余的消息写入磁盘，待消息队列消耗完毕时，将磁盘中的消息取出来放到内存消息队列中。

此外，为了避免消息服务器宕机导致消息丢失，可以将已经成功发送到消息服务器中的消息保存在生产者服务器，当消息真正被消费，再删除该消息。

消息队列的一个简单实现是：生产者往mysql中插入消息，消费者从中按时间戳排序捞消息。

